DeleteStorageGroup流程修改

目的

当前的DeleteStorageGroup流程中，需要经过三个步骤。

1. 删除PartitionRegion上的分区信息

2. 根据分区信息，删除SchemaRegion上的元数据信息，并清理缓存

3. 根据分区信息，删除DataRegion上的数据文件与目录

步骤3删除文件与目录，耗时长且容易发生异常，由此容易发生删除失败的现象。

这里讨论一种逻辑删除的方案，替代直接物理删除。将删除分为逻辑删除与物理删除，逻辑删除屏蔽存储组的读写，物理删除即删除文件的过程转为异步执行。简化删除RPC的操作，降低超时与异常现象发生的概率。

当由于数据的读写，需要通过分区表进行寻址。当分区表信息删除，分区缓存被清理之后，同名存储组的读写，将在新的region下进行。所以，只需要对旧的region，进行读写屏蔽即可实现逻辑上的删除。

![删除存储组](.\delete_sg.png)



阶段一
在partitionRegion上对存储组关联的分区信息进行预删除。拉取RPC接口中，对预删除的存储组进行过滤。

阶段二
清理datanode上partition缓存，schema缓存，对于阶段一中预删除的存储组，不再拉取缓存。

阶段三
DataNode节点上对应（Schema/Data）Region标记为已删除

阶段四
如果阶段二/三 成功，删除partitionRegion上的分区信息。
如果阶段二失败，跳过阶段三，移除预删除信息，返回删除失败。
如果阶段三部分失败，需要移除对应region的删除标记，移除预删除信息。



周期清理：
DataNode节点，通过分区表信息，定期对标记为已删除的Region进行清理。



DDL：

需要实现存储组粒度上的锁，在删除的过程中，不让创建该存储组。

对读写的影响

写入：

删除阶段二完成之后，在校验元数据的时候，需要重新拉取分区表与元数据，可以拒绝写入。

查询：

重新拉取分区表后，MPP在生成执行计划时，不会分配到预删除的dataRegion。



方案优缺点：

优点：

删除存储组不再涉及磁盘操作，RPC出现超时或I/O异常的可能性降低。

异步删除的机制，相对更安全。

缺点：

没有即时释放空间。

需要对读写接口进行修改。



